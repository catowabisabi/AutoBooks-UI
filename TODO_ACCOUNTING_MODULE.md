# æœƒè¨ˆæ¨¡çµ„æ”¹é€²è¨ˆåŠƒ (Accounting Module Improvement Plan)

> åŸºæ–¼éœ€æ±‚å°åœ–èˆ‡ç¾æœ‰å¯¦ä½œçš„è½å·®åˆ†æ

## ğŸ“Š å·²å¯¦ä½œåŠŸèƒ½

### å¾Œç«¯ (Backend - Django)
| åŠŸèƒ½ | æª”æ¡ˆä½ç½® | ç‹€æ…‹ |
|------|----------|------|
| æ”¶æ“šä¸Šå‚³èˆ‡è§£æ | `accounting_viewset.py` `/accounting-assistant/upload/` | âœ… |
| æ”¶æ“šåˆ—è¡¨/æŸ¥è©¢/æ›´æ–°/æ ¸å‡† | `list_receipts`, `get_receipt`, `update_receipt`, `approve_receipt` | âœ… |
| Excel èˆ‡ DB æ¯”å° | `compare_excel` + `ReceiptComparison` | âœ… |
| ç°¡å–®å ±è¡¨ç”Ÿæˆ | `create_report` -> `ExpenseReport` + Excel åŒ¯å‡º | âœ… |
| AI æŸ¥è©¢ | `ai_query` (ä¾è³´ `get_ai_suggestions`) | âœ… |
| æ ¸å¿ƒæœƒè¨ˆæ¨¡å‹ | ç¸½å¸³/ç§‘ç›®/åˆ†éŒ„/æ‡‰æ”¶æ‡‰ä»˜/è²»ç”¨/ä»˜æ¬¾ (`models.py`) | âœ… |

### å‰ç«¯ (Frontend - Next.js)
| åŠŸèƒ½ | æª”æ¡ˆä½ç½® | ç‹€æ…‹ |
|------|----------|------|
| åœ–è¡¨åŒ¯å‡º PNG/CSV/Excel/JSON | `chart-export-utils.ts` | âœ… æ–°å¢ |
| å°è©±æ­·å²æŒä¹…åŒ– | `useChatHistory.ts` | âœ… æ–°å¢ |

---

## ğŸ”´ é«˜å„ªå…ˆç´šç¼ºå£

### 1. ç”¨æˆ¶/è§’è‰²/ç§Ÿæˆ¶ç®¡ç†
**éœ€æ±‚**: è¨»å†Š/ç™»å…¥/å¿˜è¨˜å¯†ç¢¼/é–å®šã€å¤šè§’è‰²/ç§Ÿæˆ¶éš”é›¢
**ç¾æ³**: å¾Œç«¯ API éœ€ `IsAuthenticated`ï¼Œä½†æœªè¦‹å°ˆç”¨çš„å¸³è™Ÿ/ç§Ÿæˆ¶æµèˆ‡å‰ç«¯ UI

**å¾…å¯¦ä½œ**:
- [ ] ç§Ÿæˆ¶æ¨¡å‹ (Tenant Model)
- [ ] è§’è‰²æ¬Šé™ç³»çµ± (Role-Based Access Control)
- [ ] å‰ç«¯ç™»å…¥/è¨»å†Šé é¢
- [ ] å¿˜è¨˜å¯†ç¢¼æµç¨‹
- [ ] å¸³è™Ÿé–å®šæ©Ÿåˆ¶

---

### 2. é …ç›®ç®¡ç† (Project Management)
**éœ€æ±‚**: B1-B4 - å…¬å¸åç¨±/å¹´åº¦/å­£åº¦/é¡å‹
**ç¾æ³**: æœªç™¼ç¾ã€Œé …ç›®ã€æ¨¡å‹èˆ‡ UI

**å¾…å¯¦ä½œ**:
```python
# api/accounting/models.py
class Project(BaseModel):
    tenant = ForeignKey(Tenant)
    company_name = CharField(max_length=200)
    fiscal_year = IntegerField()
    quarter = IntegerField(choices=[(1,2,3,4)])
    project_type = CharField(choices=['audit', 'tax', 'consulting'])
    status = CharField(choices=['active', 'completed', 'archived'])
```

- [ ] Project æ¨¡å‹
- [ ] Project CRUD API
- [ ] èˆ‡ Receipt/Report é—œè¯
- [ ] å‰ç«¯é …ç›®åˆ—è¡¨é 

---

### 3. æ–‡ä»¶æ‰¹é‡ä¸Šå‚³èˆ‡åˆ†é¡
**éœ€æ±‚**: C1-C3 æ‰¹é‡ä¸Šå‚³ã€PDF/Word/å½±åƒã€LLM åˆ†é¡ã€é€²åº¦å›å ±ã€ç„¡æ³•è­˜åˆ¥æ¸…å–®
**ç¾æ³**: `upload_receipt` åƒ…æ”¯æ´å–®å¼µæ”¶æ“š

**å¾…å¯¦ä½œ**:
- [ ] æ‰¹é‡ä¸Šå‚³ API (`/accounting/bulk-upload/`)
- [ ] é€²åº¦å›å ± (WebSocket æˆ– SSE)
- [ ] PDF/Word è½‰é è¦½
- [ ] LLM åˆ†é¡ç½®ä¿¡åº¦
- [ ] ç„¡æ³•è­˜åˆ¥æ–‡ä»¶æ¸…å–®

---

### 4. å¾…è™•ç†/ç„¡æ³•è­˜åˆ¥æ¸…å–®
**éœ€æ±‚**: D1-D2 å¾…è™•ç†åˆ—è¡¨ã€ç„¡æ³•è­˜åˆ¥åˆ—è¡¨ã€æ‰‹å‹•è½‰é¡å‹
**ç¾æ³**: `list_receipts` å¯ç¯©ç‹€æ…‹ï¼Œä½†ç„¡ã€Œç„¡æ³•è­˜åˆ¥ã€å°ˆå€

**å¾…å¯¦ä½œ**:
```python
# æ–°å¢ç‹€æ…‹
DOCUMENT_STATUS = [
    ('pending', 'å¾…è™•ç†'),
    ('classified', 'å·²åˆ†é¡'),
    ('unrecognized', 'ç„¡æ³•è­˜åˆ¥'),
    ('verified', 'å·²æ ¡é©—'),
    ('approved', 'å·²æ ¸å‡†'),
]
```

- [ ] æ–°å¢ `unrecognized` ç‹€æ…‹å­—æ®µ
- [ ] ç„¡æ³•è­˜åˆ¥æ¸…å–® API
- [ ] æ‰‹å‹•åˆ†é¡ API
- [ ] æ‰¹æ¬¡æ¨™è¨˜ API

---

### 5. LLM æ•¸æ“šæå–é«˜äº®æ ¡é©—
**éœ€æ±‚**: D3-D4 æ¬„ä½é«˜äº®ã€ä¸¦æ’æª¢è¦–ã€è¡¨å–®é©—è­‰ã€ç½®ä¿¡åº¦é¡¯ç¤º
**ç¾æ³**: å¾Œç«¯å­˜æ”¾ `ai_raw_response/items`ï¼Œä½†ç„¡é«˜äº®åº§æ¨™

**å¾…å¯¦ä½œ**:
```python
# æ¬„ä½ä½ç½®çµæ§‹
class FieldExtraction(BaseModel):
    receipt = ForeignKey(Receipt)
    field_name = CharField()
    value = TextField()
    confidence = FloatField()
    bounding_box = JSONField()  # {"x": 0, "y": 0, "width": 100, "height": 20}
    is_verified = BooleanField(default=False)
```

- [ ] æ¬„ä½ä½ç½®/ç½®ä¿¡åº¦å­˜å„²
- [ ] å‰ç«¯é«˜äº®é¡¯ç¤ºçµ„ä»¶
- [ ] ä¸¦æ’åŸæª”/æ¬„ä½é è¦½
- [ ] è¡¨å–®é©—è­‰èˆ‡å³æ™‚æç¤º
- [ ] ç”¨æˆ¶ä¿®æ­£ API

---

### 6. å¯©è¨ˆè¿½è¹¤/æ­·å²ç‰ˆæœ¬
**éœ€æ±‚**: D5 å¯©è¨ˆè¿½è¹¤ã€æ­·å²ç‰ˆæœ¬
**ç¾æ³**: `BaseModel` æœ‰æ™‚é–“æˆ³ï¼Œä½†ç„¡ç‰ˆæœ¬æ­·ç¨‹

**å¾…å¯¦ä½œ**:
```python
# ä½¿ç”¨ django-simple-history æˆ–è‡ªå»º
class ReceiptHistory(models.Model):
    receipt = ForeignKey(Receipt)
    version = IntegerField()
    changed_by = ForeignKey(User)
    changed_at = DateTimeField()
    changes = JSONField()  # {"field": "amount", "old": 100, "new": 150}
```

- [ ] å®‰è£ django-simple-history æˆ–è‡ªå»º
- [ ] Receipt/Report æ­·å²è¿½è¹¤
- [ ] æ­·å²ç‰ˆæœ¬æŸ¥çœ‹ API
- [ ] å‰ç«¯ç‰ˆæœ¬æ¯”è¼ƒ UI

---

### 7. å¤šå ±è¡¨é¡å‹ç”Ÿæˆ
**éœ€æ±‚**: E1-E2 æç›Š/è³‡ç”¢è² å‚µ/ç¸½å¸³/æ˜ç´°å¸³ Excel/Word
**ç¾æ³**: `ExpenseReport` ä¸»è¦æ˜¯è²»ç”¨å ±è¡¨

**å¾…å¯¦ä½œ**:
```python
REPORT_TYPES = [
    ('income_statement', 'æç›Šè¡¨'),
    ('balance_sheet', 'è³‡ç”¢è² å‚µè¡¨'),
    ('general_ledger', 'ç¸½å¸³'),
    ('subsidiary_ledger', 'æ˜ç´°å¸³'),
    ('expense_report', 'è²»ç”¨å ±è¡¨'),
    ('trial_balance', 'è©¦ç®—è¡¨'),
]
```

- [ ] æç›Šè¡¨ç”Ÿæˆ
- [ ] è³‡ç”¢è² å‚µè¡¨ç”Ÿæˆ
- [ ] ç¸½å¸³/æ˜ç´°å¸³ç”Ÿæˆ
- [ ] Excel/Word åŒ¯å‡º
- [ ] ã€Œæ›´æ–°ç¾æœ‰å ±å‘Šã€å·¥ä½œæµ

---

### 8. æœƒè¨ˆå‰ç«¯é é¢
**éœ€æ±‚**: å°ˆæ¡ˆåˆ—è¡¨ã€æ–‡ä»¶ä¸Šå‚³ã€å¾…è™•ç†/ç„¡æ³•è­˜åˆ¥ã€å¯©æ ¸ã€å ±è¡¨ä¸­å¿ƒ
**ç¾æ³**: å‰ç«¯ç„¡æœƒè¨ˆç›¸é—œé é¢

**å¾…å¯¦ä½œ**:
```
src/app/dashboard/accounting/
â”œâ”€â”€ page.tsx                    # æœƒè¨ˆç¸½è¦½
â”œâ”€â”€ projects/
â”‚   â”œâ”€â”€ page.tsx               # å°ˆæ¡ˆåˆ—è¡¨
â”‚   â””â”€â”€ [id]/page.tsx          # å°ˆæ¡ˆè©³æƒ…
â”œâ”€â”€ documents/
â”‚   â”œâ”€â”€ page.tsx               # æ–‡ä»¶åˆ—è¡¨
â”‚   â”œâ”€â”€ upload/page.tsx        # æ‰¹é‡ä¸Šå‚³
â”‚   â””â”€â”€ unrecognized/page.tsx  # ç„¡æ³•è­˜åˆ¥
â”œâ”€â”€ review/
â”‚   â””â”€â”€ page.tsx               # å¯©æ ¸ä¸­å¿ƒ
â””â”€â”€ reports/
    â”œâ”€â”€ page.tsx               # å ±è¡¨ä¸­å¿ƒ
    â””â”€â”€ generate/page.tsx      # ç”Ÿæˆå ±è¡¨
```

---

## ğŸŸ  ä¸­å„ªå…ˆç´š

### 9. AI é«”é©—å¢å¼·
- [ ] ç½®ä¿¡åº¦é¡¯ç¤ºåœ¨ UI
- [ ] ç”¨æˆ¶åé¥‹ API (`/ai/feedback/`)
- [ ] å¯è§£é‡‹æ€§èªªæ˜
- [ ] æ¬„ä½æ•¸æ“šé«˜äº®

### 10. ç•°æ­¥ä»»å‹™è™•ç†
- [ ] å®‰è£ Celery/RQ
- [ ] é•·ä»»å‹™ç•°æ­¥åŒ–
- [ ] ä»»å‹™é€²åº¦æŸ¥è©¢ç«¯é»
- [ ] å‰ç«¯é€²åº¦æ¢

### 11. ä¸Šå‚³å®‰å…¨å¼·åŒ–
- [ ] æª”æ¡ˆå¤§å°é™åˆ¶ (10MB)
- [ ] MIME é¡å‹é©—è­‰
- [ ] ç—…æ¯’æƒææ•´åˆ
- [ ] å±éšªå…§å®¹æª¢æ¸¬

---

## ğŸŸ¡ ä½å„ªå…ˆç´š

### 12. UX å¢å¼·
- [ ] æ–°æ‰‹å¼•å°
- [ ] å·¥å…·æç¤º
- [ ] é€²åº¦/é ä¼°æ™‚é–“é¡¯ç¤º
- [ ] éŒ¯èª¤å‹å–„è¨Šæ¯
- [ ] ç”¨æˆ¶åå¥½è¨˜æ†¶
- [ ] å¿«æ·éµæ”¯æ´
- [ ] ç„¡éšœç¤™ (a11y)

### 13. å¤–éƒ¨æ•´åˆ
- [ ] å¤–éƒ¨æœƒè¨ˆè»Ÿé«” API
- [ ] éŠ€è¡Œ API å°æ¥
- [ ] ç¬¬ä¸‰æ–¹æ–‡ä»¶è™•ç†æœå‹™

---

## ğŸ“ æª”æ¡ˆä½ç½®åƒè€ƒ

### å¾Œç«¯
```
api/
â”œâ”€â”€ accounting/
â”‚   â”œâ”€â”€ models.py              # æœƒè¨ˆæ¨¡å‹
â”‚   â”œâ”€â”€ views.py               # CRUD API
â”‚   â”œâ”€â”€ serializers.py         # åºåˆ—åŒ–
â”‚   â””â”€â”€ urls.py                # è·¯ç”±
â”œâ”€â”€ ai_assistants/
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ accounting_viewset.py  # AI æœƒè¨ˆ API
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ accounting_service.py  # æ¥­å‹™é‚è¼¯
```

### å‰ç«¯
```
src/app/dashboard/
â”œâ”€â”€ analyst-assistant/         # åˆ†æåŠ©æ‰‹ (å·²å¯¦ä½œ)
â”‚   â”œâ”€â”€ _components/
â”‚   â”‚   â”œâ”€â”€ chart-export-utils.ts  # åœ–è¡¨åŒ¯å‡º âœ…
â”‚   â”‚   â””â”€â”€ useChatHistory.ts      # å°è©±æŒä¹…åŒ– âœ…
â”‚   â””â”€â”€ page.tsx
â””â”€â”€ accounting/                # æœƒè¨ˆæ¨¡çµ„ (å¾…å»ºç«‹)
    â””â”€â”€ ...
```

---

## ğŸš€ å¯¦ä½œé †åºå»ºè­°

### Phase 1 - åŸºç¤æ¶æ§‹ (1-2 é€±)
1. Project æ¨¡å‹èˆ‡ API
2. æ–‡ä»¶ç‹€æ…‹æ“´å±• (unrecognized)
3. æœƒè¨ˆå‰ç«¯é é¢éª¨æ¶

### Phase 2 - æ ¸å¿ƒåŠŸèƒ½ (2-3 é€±)
4. æ‰¹é‡ä¸Šå‚³ API
5. LLM åˆ†é¡èˆ‡ç½®ä¿¡åº¦
6. æ¬„ä½é«˜äº®æ ¡é©—

### Phase 3 - å ±è¡¨èˆ‡å¯©è¨ˆ (2-3 é€±)
7. å¤šå ±è¡¨é¡å‹ç”Ÿæˆ
8. å¯©è¨ˆè¿½è¹¤å¯¦ä½œ
9. å ±è¡¨ä¸­å¿ƒ UI

### Phase 4 - å„ªåŒ–èˆ‡å®‰å…¨ (1-2 é€±)
10. ç•°æ­¥ä»»å‹™ (Celery)
11. ä¸Šå‚³å®‰å…¨å¼·åŒ–
12. UX å¢å¼·

---

*æœ€å¾Œæ›´æ–°: 2024-12-07*
